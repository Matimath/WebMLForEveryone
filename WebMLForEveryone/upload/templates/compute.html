<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <meta name="description" content="">
    <meta name="author" content="">
    <!-- <link rel="icon" href="../../favicon.ico"> -->

    {% load staticfiles %}

    <title>Project Name - Upload</title>


    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
          integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="{% static 'ie10-viewport-bug-workaround.css' %}" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{% static 'ie10-viewport-bug-workaround.js' %}"></script>

    <!-- Custom styles for this template -->
    <link href="{% static 'justified-nav.css' %}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- For excel-like views -->
    <link href="http://docs.handsontable.com/0.25.1/bower_components/handsontable/dist/handsontable.full.css" rel="stylesheet"></link>
    <script src="http://docs.handsontable.com/0.25.1/bower_components/handsontable/dist/handsontable.full.js"></script>

    <!-- For easy form submitting -->
    <script src="http://malsup.github.com/jquery.form.js"></script>

    <!-- getCookie function -->
    <script src="{% static 'getCookie.js' %}"></script>
</head>

<body>

<div class="container">
    <!-- Nazwa projektu i nazwy zakładek są jeszcze do ustalenia i ewentualnej zmiany -->
    <div class="masthead">
        <h3 class="text-muted">Project name</h3>
        <nav>
            <ul class="nav nav-justified">
                <li><a href="index.html">Home</a></li>
                <li class="active"><a href="#">Upload</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </div>

    <ol class="breadcrumb">
        <li><a href="{% url 'upload' %}">Upload</a></li>
        <li><a href="/upload/choose/{{ id }}">Choose</a></li>
        <li class="active">Compute</li>
    </ol>


    <div id="alert-panel" class="row">
        <div class="col-sm-12 col-md-8 col-lg-8 col-md-offset-2 col-lg-offset-2">
            <div id="model-type" class="alert alert-success" style="width: 100%;">We are ready to make predictions. Choose your input method.</div>
        </div>
    </div>

    <div id="upload-file" class="row">
        <!--<h3><i>Upload file</i></h3>-->
        <form id="upload-file-form" action="{% url 'ajax_upload_file' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <input type="text" name="model_builder" value="{{ model_builder }}" style="display: none;">

            <div class="col-sm-12 col-md-8 col-lg-8 col-md-offset-2 col-lg-offset-2">
                <div class="input-group">
                    <label class="input-group-btn">
                        <span class="btn btn-primary">
                            Browse&hellip; <input type="file" name="docfile" style="display: none;">
                        </span>
                    </label>
                    <input type="text" class="form-control" readonly>
                    <span class="input-group-btn">
                        <!-- Loads excel file to front-end excel-like sheet -->
                        <button id="upload-file-button" class="btn btn-default" type="submit">Load</button>
                        <!-- Loads file to server, server makes predictions and lets you download the new file -->
                        <button id="upload-file-then-save-button" class="btn btn-info">Instant prediction</button>
                    </span>
                </div>
            </div>
        </form>
    </div>

    <br/>

    <div id="prediction-panel">
        <div class="row">
            <div class="col-sm-12 col-md-8 col-lg-8 col-md-offset-2 col-lg-offset-2">
                <div id="excel-table"></div>
            </div>
        </div>
        </br>
        <div class="row">
            <div class="col-sm-6 col-md-4 col-lg-4 col-sm-offset-3 col-md-offset-4 col-lg-offset-4">
                <button id="add-rows-button" class="btn btn-default" style="width: 45%;">Add more rows</button>
                <button id="predict-button" class="btn btn-info" style="width: 30%;">Predict</button>
                <button id="save-button" class="btn btn-warning" style="width: 20%;">Save</button>
            </div>
        </div>
    </div>

    <!-- Invisible iframe for downloading documents -->
    <iframe id="my_iframe" style="display:none;"></iframe>

    <script type="application/javascript">
        $(document).ready(function () {

            var hotElement = document.getElementById('excel-table');

            var get_columns = function() {
                var columns = [];
                var column;
                {% for col in columns %}
                    column = {
                        data: '{{ col.data }}',
                        type: '{{ col.type }}'
                    };
                    columns.push(column);
                {% endfor %}
                return columns;
            };

            var get_columns_names = function() {
                var names = [];
                {% for column in columns %}
                    names.push('{{ column.name }}');
                {% endfor %}
                return names;
            }

            var min_nr_of_rows = 7;

            var hotSettings = {
                data: [],
                columns: get_columns(),
                stretchH: 'all',
                autoWrapRow: true,
                minRows: min_nr_of_rows,
                height: 200,
                rowHeaders: true,
                colHeaders: get_columns_names()
            };

            var hot = new Handsontable(hotElement, hotSettings);

            $('#upload-file-then-save-button').click(function() {
                $('#upload-file-form').ajaxForm({
                    url: '/upload/ajax/upload_predict_save/',
                    dataType: 'json',
                    success: function(data) {
                        document.getElementById('my_iframe').src = data['url'];
                    }
                });
            });

            $('#upload-file-button').click(function() {
                $('#upload-file-form').ajaxForm({
                    url: $('#upload-file-form').attr('action'),
                    dataType: 'json',
                    success: function(data) {
                        var doc_id = data['document_id'];
                        var rows = data['data'];

                        // transform rows (array of arrays) to array of dicts
                        var new_data = [];
                        for (var i = 0; i < rows.length; ++i) {
                            var row = rows[i];
                            new_row = {};
                            {% for col in columns %}
                                new_row['{{ col.name }}'] = row[{{ forloop.counter }} - 1];
                            {% endfor %}
                            new_data.push(new_row);
                        }

                        hotSettings['minRows'] = new_data.length > min_nr_of_rows ? new_data.length : min_nr_of_rows;
                        hotSettings['data'] = new_data;
                        while(hotElement.firstChild)
                            hotElement.removeChild(hotElement.firstChild);
                        hot = new Handsontable(hotElement, hotSettings);
                    }
                });
            });

            $('#add-rows-button').click(function() {
                add_more_rows(3);
            });

            $('#save-button').click(function() {
                save_excel_table();
            });

            $('#predict-button').click(function() {
                predict();
            });

            // adds more rows to excel table
            var add_more_rows = function(nr_of_new_rows) {
                var data = hotSettings['data'];
                hotSettings['minRows'] = data.length + nr_of_new_rows;
                while(hotElement.firstChild)
                    hotElement.removeChild(hotElement.firstChild);
                hot = new Handsontable(hotElement, hotSettings);
            };

            // saves excel table to file
            var save_excel_table = function() {
                var data = hot.getData();
                var columns = get_columns_names();
                $.post('/upload/ajax/save_to_excel/', {
                    'columns': JSON.stringify(columns),
                    'data': JSON.stringify(data),
                    csrfmiddlewaretoken: getCookie('csrftoken')
                })
                .done(function(response_data) {
                    document.getElementById('my_iframe').src = response_data['url'];
                })
                .fail(function(xhr, textStatus, errorThrown) {
                    alert(xhr.responseText);
                });
            };

            // makes predictions (excel table as input)
            var predict = function() {
                var data = hot.getData(); // returns array of rows
                $.get('/upload/ajax/predict/', {
                    'model_builder': {{ model_builder }},
                    'column_index': {{ column_index }},
                    'data': JSON.stringify(data)
                    //csrfmiddlewaretoken: getCookie('csrftoken')
                })
                .done(function(data) {
                    for (var i = 0; i < data['predictions'].length; ++i)
                        hot.setDataAtCell(i, {{ column_index }}, data['predictions'][i]);
                })
                .fail(function(xhr, textStatus, errorThrown) {
                    alert(xhr.responseText);
                });
            };
        })
    </script>

    <script src="{% static 'upload.js' %}"></script>


    <!-- Site footer -->
    <footer class="footer">
        <p>&copy; footer or something (may be deleted if unnecessary)</p>
    </footer>

</div> <!-- /container -->
</body>
</html>

